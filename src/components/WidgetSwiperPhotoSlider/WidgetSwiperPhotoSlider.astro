---
import type { WidgetSwiperPhotoSliderProps as Props } from './types';
import Headline from '../Headline/Headline.astro';
import WidgetWrapper from '../WidgetWrapper/WidgetWrapper.astro';
import SwiperSlider from '../SwiperSlider/SwiperSlider.astro';
import { Image as AstroImage, getImage } from 'astro:assets';
import { fetchLocalImages } from '../../utils/images';
import { cn } from '../../utils';
import Button from "../Button/Button.astro";

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),
  imagesFolder,
  alt,
  position = 'center',
  asHeader = 'h2',
  asSubtitle = 'p',
  isAfterContent = false,
  callToAction,

  id = (Math.random() + 1).toString(36).substring(7),
  withNavigation = true,
  isDark = false,
  bg = await Astro.slots.render('bg'),
  classes = {},
  ...rest
} = Astro.props;

const images = await fetchLocalImages() as Record<string, () => any>;
const imagePaths = Object.keys(images).filter((imagePath) => {
  return imagePath.startsWith(`/src/assets/images/${imagesFolder}/`);
});
---

<WidgetWrapper
  id={id}
  isDark={isDark}
  bg={bg}
  containerClass={`gallery ${isAfterContent ? 'pt-0 md:pt-0 lg:pt-0' : ''} ${classes?.container}`}
>
  <Headline
    title={title}
    subtitle={subtitle}
    tagline={tagline}
    classes={classes?.headline as Record<string, string>}
    position={position}
    as={asHeader}
    asSubtitle={asSubtitle}
  />

  {
    imagePaths && (
      <SwiperSlider id={id} withNavigation={withNavigation} {...rest}>
        {imagePaths.map(async (imagePath, index) => {
          let image = images[imagePath]();
          let optimizedImage = await getImage({
            src: image,
            width: 860,
          });

          // Generate alt text: alt prop > title-based > numbered fallback
          // Detect UUID filenames (8-4-4-4-12 hex pattern) and treat as meaningless
          const filename = imagePath.split('/').pop()?.replace(/\.[^/.]+$/, '') || '';
          const isUuidFilename = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(filename);
          const imageNumber = index + 1;
          const imageName = (filename && !isUuidFilename) ? filename : String(imageNumber);
          const baseTitle = title ? String(title).replace(/<[^>]*>/g, '').trim() : '';
          const altText = alt
            ? alt + ' - ' + imageName
            : baseTitle
              ? baseTitle + ' - ' + imageName
              : 'Image ' + imageName;

          return (
            <swiper-slide>
              <a
                href={optimizedImage.src}
                data-pswp-width={optimizedImage.attributes.width}
                data-pswp-height={optimizedImage.attributes.height}
                target="_blank"
                title={altText}
                class="group overflow-hidden rounded-md border-primary cursor-zoom-in block aspect-square"
              >
                <AstroImage
                  src={image}
                  alt={altText}
                  title={altText}
                  widths={[400, 900]}
                  width={400}
                  sizes="(max-width: 900px) 400px, 900px"
                  class={cn("object-cover object-top w-full md:h-full group-hover:scale-105 transition duration-300", classes?.image)}
                />
              </a>
            </swiper-slide>
          );
        })}
      </SwiperSlider>
    )
  }

  {
    callToAction && (
      <div class="flex justify-center mx-auto w-fit mt-8 md:mt-12 font-medium">
        <Button {...(callToAction as any)} />
      </div>
    )
  }
  
  <slot />
</WidgetWrapper>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import 'photoswipe/style.css';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '.gallery',
    children: 'a',
    pswpModule: () => import('photoswipe'),
  });

  lightbox.init();
</script>
