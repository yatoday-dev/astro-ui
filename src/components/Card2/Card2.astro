---
import type { Card2Props as Props } from './types';
import Card0 from '../Card0/Card0.astro';
import Image from '../Image/Image.astro';
import { Icon } from 'astro-icon/components';
import { twMerge } from 'tailwind-merge';
import { cn } from '../../utils';

const {
  title = await Astro.slots.render('title'),
  description = await Astro.slots.render('description'),
  icon,
  image = await Astro.slots.render('image'),
  images,
  url = '',
  callToAction,
  classes = {},
  as = 'article',
  asHeader = 'h3',
  badge = await Astro.slots.render('badge'),
  badgeTopRight = await Astro.slots.render('badgeTopRight'),
  badgeBottomRight = await Astro.slots.render('badgeBottomRight'),
  badgeBottomLeft = await Astro.slots.render('badgeBottomLeft'),
} = Astro.props;

const WrapperHeaderTag = asHeader;

const {
  container: containerClass = '',
  title: titleClass = '',
  content: contentClass = 'text-muted-foreground',
  icon: iconClass = '',
  image: imageClass = '',
  imageLayout: imageLayout = 'cover',
  badge: badgeClass = 'top-2 left-2',
} = classes as {
  // Ensure imageLayout is typed as the Layout union, not just string
  imageLayout?: 'fixed' | 'constrained' | 'fullWidth' | 'cover' | 'responsive' | 'contained';
} & Record<string, string>;

// Use images array if provided, otherwise fall back to single image
const hasMultipleImages = images && images.length > 1;
---

<Card0
  as={as}
  badge={badge}
  badgeTopRight={badgeTopRight}
  badgeBottomRight={badgeBottomRight}
  badgeBottomLeft={badgeBottomLeft}
  classes={{
    container: cn('group', containerClass),
    badge: badgeClass,
    badgeTopRight: classes?.badgeTopRight,
  }}
>
  <!-- Image -->
  <Fragment slot="image">
    {
      (image || hasMultipleImages) && (
        <div class={twMerge('relative w-full overflow-hidden -mt-6 h-40 bg-gray-400 dark:bg-zinc-700', imageClass)}>

          {(Astro.slots.has('badgeBottomRight') || badgeBottomRight) && (
            <div class={twMerge('absolute z-10 bottom-2 right-2', classes?.badgeBottomRight)}>
              <slot name="badgeBottomRight">
                {badgeBottomRight && <span set:html={badgeBottomRight}/>}
              </slot>
            </div>
          )}

          {(Astro.slots.has('badgeBottomLeft') || badgeBottomLeft) && (
            <div class={twMerge('absolute z-10 bottom-2 left-2', classes?.badgeBottomLeft)}>
              <slot name="badgeBottomLeft">
                {badgeBottomLeft && <span set:html={badgeBottomLeft}/>}
              </slot>
            </div>
          )}

          {hasMultipleImages ? (
            /* Multi-image gallery with hover zones */
            <div class="card2-gallery relative w-full h-full" data-image-count={images.length}>
              {/* All images stacked, first visible by default */}
              {images.map((img, index) => (
                <div
                  class={cn(
                    'card2-gallery-image absolute inset-0 transition-opacity duration-200',
                    index === 0 ? 'opacity-100' : 'opacity-0'
                  )}
                  data-index={index}
                >
                  {typeof img === 'string' ? (
                    <Fragment set:html={img} />
                  ) : (
                    <Image
                      class={cn(
                        'w-full md:h-full',
                        imageClass,
                        (url || callToAction?.href) && 'group-hover:scale-105 transition duration-300'
                      )}
                      widths={[400, 900]}
                      width={400}
                      height={400}
                      sizes="(max-width: 900px) 400px, 900px"
                      layout={imageLayout}
                      loading={index === 0 ? 'eager' : 'lazy'}
                      decoding="async"
                      {...img}
                    />
                  )}
                </div>
              ))}

              {/* Invisible hover zones */}
              <div class="absolute inset-0 flex z-20">
                {images.map((_, index) => (
                  <div
                    class="card2-hover-zone flex-1 h-full cursor-pointer"
                    data-zone={index}
                  />
                ))}
              </div>

              {/* Indicator dots */}
              <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1 z-10">
                {images.map((_, index) => (
                  <div
                    class={cn(
                      'card2-indicator w-1.5 h-1.5 rounded-full transition-all duration-200',
                      index === 0
                        ? 'bg-white'
                        : 'bg-white/50'
                    )}
                    data-indicator={index}
                  />
                ))}
              </div>
            </div>
          ) : typeof image === 'string' ? (
            <Fragment set:html={image} />
          ) : image && (
            <Image
              class={cn(
                'w-full md:h-full',
                imageClass,
                (url || callToAction?.href) && 'group-hover:scale-105 transition duration-300'
              )}
              widths={[400, 900]}
              width={400}
              height={400}
              sizes="(max-width: 900px) 400px, 900px"
              layout={imageLayout}
              loading="lazy"
              decoding="async"
              {...image}
            />
          )}
        </div>
      )
    }

    {
      icon && (
        <div class="h-12 px-6">
          <Icon
            name={icon}
            class={cn(
              'w-12 h-12 text-primary group-hover:scale-105 transition duration-300',
              image ? 'mt-6' : '',
              iconClass,
              url || (callToAction?.href && 'group-hover:scale-105 transition duration-300')
            )}
          />
        </div>
      )
    }
  </Fragment>

  <!-- Content -->
  <div class={twMerge('px-6 space-y-6')}>
    <div>
      <WrapperHeaderTag class={twMerge('text-xl font-bold', titleClass)}>
        {
          url || callToAction?.href ? (
            <a href={url || callToAction?.href || '/'} class="after:content-[''] after:inset-0 after:absolute">
              {title}
            </a>
          ) : (
            title
          )
        }
      </WrapperHeaderTag>

      <div class={twMerge('mt-2', contentClass)}>
        <slot />
        {description}
      </div>
    </div>
  </div>
</Card0>

<script>
  function initCard2Galleries() {
    document.querySelectorAll('.card2-gallery').forEach((gallery) => {
      const zones = gallery.querySelectorAll('.card2-hover-zone');
      const images = gallery.querySelectorAll('.card2-gallery-image');
      const indicators = gallery.querySelectorAll('.card2-indicator');

      zones.forEach((zone) => {
        zone.addEventListener('mouseenter', () => {
          const index = parseInt(zone.getAttribute('data-zone') || '0', 10);

          // Update images visibility
          images.forEach((img, i) => {
            if (i === index) {
              img.classList.remove('opacity-0');
              img.classList.add('opacity-100');
            } else {
              img.classList.remove('opacity-100');
              img.classList.add('opacity-0');
            }
          });

          // Update indicators
          indicators.forEach((ind, i) => {
            if (i === index) {
              ind.classList.remove('bg-white/50');
              ind.classList.add('bg-white');
            } else {
              ind.classList.remove('bg-white');
              ind.classList.add('bg-white/50');
            }
          });
        });
      });

      // Reset to first image on mouse leave
      gallery.addEventListener('mouseleave', () => {
        images.forEach((img, i) => {
          if (i === 0) {
            img.classList.remove('opacity-0');
            img.classList.add('opacity-100');
          } else {
            img.classList.remove('opacity-100');
            img.classList.add('opacity-0');
          }
        });

        indicators.forEach((ind, i) => {
          if (i === 0) {
            ind.classList.remove('bg-white/50');
            ind.classList.add('bg-white');
          } else {
            ind.classList.remove('bg-white');
            ind.classList.add('bg-white/50');
          }
        });
      });
    });
  }

  // Initialize on page load
  initCard2Galleries();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initCard2Galleries);
</script>
