---
import type { Card1Props as Props } from './types';
import Card0 from '../Card0/Card0.astro';
import Image from '../Image/Image.astro';
import Button from '../Button/Button.astro';
import { Icon } from 'astro-icon/components';
import { twMerge } from 'tailwind-merge';
import { cn } from '../../utils';

const {
  title = await Astro.slots.render('title'),
  description = await Astro.slots.render('description'),
  image = await Astro.slots.render('image'),
  icon,
  data = [],
  links = [],
  callToAction = await Astro.slots.render('actions'),
  classes = {},
  as = 'article',
  asHeader = 'h3',
  badge = await Astro.slots.render('badge'),
  badgeTopRight = await Astro.slots.render('badgeTopRight'),
  badgeBottomRight = await Astro.slots.render('badgeBottomRight'),
  badgeBottomLeft = await Astro.slots.render('badgeBottomLeft'),
} = Astro.props;

const WrapperHeaderTag = asHeader;

const {
  title: titleClass = '',
  description: descriptionClass = 'text-muted-foreground',
  image: imageClass = '',
  imageLayout: imageLayout = 'cover',
  icon: iconClass = '',
  quickLink: quickLinkClass = 'font-semibold underline text-primary hover:text-primary/80',
  action: actionClass = '',
} = classes as {
  // Ensure imageLayout is typed as the Layout union, not just string
  imageLayout?: 'fixed' | 'constrained' | 'fullWidth' | 'cover' | 'responsive' | 'contained';
} & Record<string, string>;

const urlForImage = Array.isArray(callToAction)
  ? typeof callToAction[0] === 'string'
    ? callToAction[0]
    : (callToAction[0] as { href?: string })?.href
  : typeof callToAction === 'string'
    ? callToAction
    : (callToAction as { href?: string })?.href;
---

<Card0
  as={as}
  badge={badge}
  badgeTopRight={badgeTopRight}
  badgeBottomRight={badgeBottomRight}
  badgeBottomLeft={badgeBottomLeft}
  classes={{
    content: 'space-y-6',
    badge: classes?.badge,
    badgeTopRight: classes?.badgeTopRight,
  }}
>
  <Fragment slot="image">
    {
      image && (
        <div class={twMerge('relative w-full overflow-hidden -mt-6 h-60 bg-gray-400 dark:bg-zinc-700', imageClass)}>

          {(Astro.slots.has('badgeBottomRight') || badgeBottomRight) && (
            <div class={twMerge('absolute z-10 bottom-2 right-2', classes?.badgeBottomRight)}>
              <slot name="badgeBottomRight">
                {badgeBottomRight && <span set:html={badgeBottomRight}/>}
              </slot>
            </div>
          )}

          {(Astro.slots.has('badgeBottomLeft') || badgeBottomLeft) && (
            <div class={twMerge('absolute z-10 bottom-2 left-2', classes?.badgeBottomLeft)}>
              <slot name="badgeBottomLeft">
                {badgeBottomLeft && <span set:html={badgeBottomLeft}/>}
              </slot>
            </div>
          )}
          
          {urlForImage ? (
            <a href={urlForImage} class="group">
              {typeof image === 'string' ? (
                <Fragment set:html={image} />
              ) : (
                <Image
                  class={twMerge('w-full h-full  hover:scale-105 transition duration-300')}
                  widths={[320, 480]}
                  width={400}
                  height={400}
                  sizes="(max-width: 640px) 100vw, (max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
                  layout={imageLayout}
                  loading="lazy"
                  decoding="async"
                  {...image}
                />
              )}
            </a>
          ) : (
            <Fragment>
              {typeof image === 'string' ? (
                <Fragment set:html={image} />
              ) : (
                <Image
                  class={twMerge('w-full h-full')}
                  widths={[320, 480]}
                  width={400}
                  height={400}
                  sizes="(max-width: 640px) 100vw, (max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
                  layout={imageLayout}
                  loading="lazy"
                  decoding="async"
                  {...image}
                />
              )}
            </Fragment>
          )}
        </div>
      )
    }

    {
      icon && (
        <div class="px-6">
          <Icon name={icon} class={twMerge('w-12 h-12 text-primary', image ? 'mt-6' : '', iconClass)} />
        </div>
      )
    }
  </Fragment>

  <div class={twMerge('px-6 space-y-6')}>
    <!-- Title & Description -->
    <div>
      <WrapperHeaderTag class={twMerge('text-base/5 md:text-xl font-bold', titleClass)}>
        {title}
      </WrapperHeaderTag>

      <div class={twMerge('mt-1', descriptionClass)}>
        <slot />
        {description}
      </div>
    </div>

    {
      links && links.length > 0 && (
        <div class="flex flex-col">
          {links.map((link) => (
            <a href={link.href} class={twMerge('transition-colors', quickLinkClass)}>
              {link.text}
            </a>
          ))}
        </div>
      )
    }
  </div>

  {
    data && data.length > 0 && (
      <div class="text-sm">
        {data.map((item) => (
          <div class="flex items-center justify-between py-2 px-6 odd:bg-white even:bg-slate-50 dark:odd:bg-transparent dark:even:bg-zinc-800">
            <div class="text-muted-foreground">{item.name}</div>
            <div>{item.value}</div>
          </div>
        ))}
      </div>
    )
  }

  {
    callToAction && (
      <div class={twMerge('w-full px-6')}>
        <slot name="footer" />

        {Array.isArray(callToAction) ? (
          <div class={cn('flex gap-2', actionClass)}>
            {callToAction.map((action) => (
              <Fragment>
                {typeof action === 'string' ? <Fragment set:html={action} /> : <Button {...(action as any || {})} />}
              </Fragment>
            ))}
          </div>
        ) : (
          <Fragment>
            {typeof callToAction === 'string' ? (
              <Fragment set:html={callToAction} />
            ) : (
              <div class={cn('', actionClass)}>
                <Button {...(callToAction as Object)} />
              </div>
            )}
          </Fragment>
        )}
      </div>
    )
  }
</Card0>
