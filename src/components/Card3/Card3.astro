---
import type { Card3Props as Props } from './types';
import Card0 from '../Card0/Card0.astro';
import ImageGallery from '../ImageGallery/ImageGallery.astro';
import Button from '../Button/Button.astro';
import { twMerge } from 'tailwind-merge';
import { cn } from '../../utils';

const {
  title = await Astro.slots.render('title'),
  description,
  callToAction = await Astro.slots.render('actions'),
  image = await Astro.slots.render('image'),
  classes = {},
  as = 'article',
  asHeader = 'h3',
  badge = await Astro.slots.render('badge'),
  badgeTopRight = await Astro.slots.render('badgeTopRight'),
  badgeBottomRight = await Astro.slots.render('badgeBottomRight'),
  badgeBottomLeft = await Astro.slots.render('badgeBottomLeft'),
} = Astro.props;

const WrapperHeaderTag = asHeader;

const {
  container: containerClass = 'bg-transparent border-transparent',
  title: titleClass = '',
  description: descriptionClass = 'text-muted-foreground',
  image: imageClass = '',
  imageLayout: imageLayout = 'cover',
  action: actionClass = '',
  badge: badgeClass = 'top-2 left-2',
} = classes as {
  // Ensure imageLayout is typed as the Layout union, not just string
  imageLayout?: 'fixed' | 'constrained' | 'fullWidth' | 'cover' | 'responsive' | 'contained';
} & Record<string, string>;

const urlForImage = Array.isArray(callToAction)
  ? typeof callToAction[0] === 'string'
    ? callToAction[0]
    : (callToAction[0] as { href?: string })?.href
  : typeof callToAction === 'string'
    ? callToAction
    : (callToAction as { href?: string })?.href;

// Check if image is a string (HTML) or actual image data
const isHtmlImage = typeof image === 'string' && !Array.isArray(image);
---

<Card0
  as={as}
  badge={badge}
  badgeTopRight={badgeTopRight}
  badgeBottomRight={badgeBottomRight}
  badgeBottomLeft={badgeBottomLeft}
  classes={{
    container: twMerge(containerClass, 'justify-start py-0'),
    badge: badgeClass,
    badgeTopRight: classes?.badgeTopRight,
  }}
>
  <Fragment slot="image">
    {
      image && (
        <div
          class={twMerge('relative w-full aspect-square overflow-hidden rounded-lg bg-gray-400 dark:bg-zinc-700', imageClass)}
        >
          {urlForImage ? (
            <a href={urlForImage} class="group block w-full h-full">
              {isHtmlImage ? (
                <Fragment set:html={image} />
              ) : (
                <ImageGallery
                  image={image}
                  imageClass=""
                  imageLayout={imageLayout}
                  widths={[400, 900]}
                  width={400}
                  height={400}
                  sizes="(max-width: 900px) 400px, 900px"
                  hoverEffect={true}
                >
                  {(Astro.slots.has('badgeBottomRight') || badgeBottomRight) && (
                    <Fragment slot="badgeBottomRight">
                      <div class={twMerge('', classes?.badgeBottomRight)}>
                        <slot name="badgeBottomRight">
                          {badgeBottomRight && <span set:html={badgeBottomRight}/>}
                        </slot>
                      </div>
                    </Fragment>
                  )}
                  {(Astro.slots.has('badgeBottomLeft') || badgeBottomLeft) && (
                    <Fragment slot="badgeBottomLeft">
                      <div class={twMerge('', classes?.badgeBottomLeft)}>
                        <slot name="badgeBottomLeft">
                          {badgeBottomLeft && <span set:html={badgeBottomLeft}/>}
                        </slot>
                      </div>
                    </Fragment>
                  )}
                </ImageGallery>
              )}
            </a>
          ) : (
            <Fragment>
              {isHtmlImage ? (
                <Fragment set:html={image} />
              ) : (
                <ImageGallery
                  image={image}
                  imageClass=""
                  imageLayout={imageLayout}
                  widths={[400, 900]}
                  width={400}
                  height={400}
                  sizes="(max-width: 900px) 400px, 900px"
                  hoverEffect={false}
                >
                  {(Astro.slots.has('badgeBottomRight') || badgeBottomRight) && (
                    <Fragment slot="badgeBottomRight">
                      <div class={twMerge('', classes?.badgeBottomRight)}>
                        <slot name="badgeBottomRight">
                          {badgeBottomRight && <span set:html={badgeBottomRight}/>}
                        </slot>
                      </div>
                    </Fragment>
                  )}
                  {(Astro.slots.has('badgeBottomLeft') || badgeBottomLeft) && (
                    <Fragment slot="badgeBottomLeft">
                      <div class={twMerge('', classes?.badgeBottomLeft)}>
                        <slot name="badgeBottomLeft">
                          {badgeBottomLeft && <span set:html={badgeBottomLeft}/>}
                        </slot>
                      </div>
                    </Fragment>
                  )}
                </ImageGallery>
              )}
            </Fragment>
          )}
        </div>
      )
    }
  </Fragment>

  <div class="flex items-start gap-2">
    <div>
      {title && (
        <WrapperHeaderTag class={cn('text-lg md:text-xl font-bold', titleClass)}>
          {title}
        </WrapperHeaderTag>
      )}

      <div class={cn(title ? 'mt-2' : '', 'text-sm md:text-base leading-5 md:leading-6', descriptionClass)}>
        <slot />
        {description}
      </div>
    </div>

    {
      callToAction && (
        <div>
          <slot name="footer" />

          {Array.isArray(callToAction) ? (
            <div class={cn('flex gap-2', actionClass)}>
              {callToAction.map((action) => (
                <Fragment>
                  {typeof action === 'string' ? <Fragment set:html={action} /> : <Button {...(action as any || {})} />}
                </Fragment>
              ))}
            </div>
          ) : (
            <Fragment>
              {typeof callToAction === 'string' ? (
                <Fragment set:html={callToAction} />
              ) : (
                <div class={cn('', actionClass)}>
                  <Button {...(callToAction as Object)} />
                </div>
              )}
            </Fragment>
          )}
        </div>
      )
    }
  </div>
</Card0>
