---
import type { WidgetFaq2Props as Props } from './types';
import WidgetWrapper from '../WidgetWrapper/WidgetWrapper.astro';
import Headline from '../Headline/Headline.astro';
import { cn } from '~/utils';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),
  items = [],
  isAfterContent = false,
  position = 'center',
  asHeader = 'h2',
  asSubtitle = 'p',
  openFirstItem = true,
  openAllItems = false,
  id,
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;
---

<WidgetWrapper
  id={id}
  isDark={isDark}
  containerClass={`${isAfterContent ? 'pt-0 md:pt-0 lg:pt-0' : ''} ${classes?.container ?? ''}`}
  bg={bg}
>
  <Headline
    title={title}
    subtitle={subtitle}
    tagline={tagline}
    classes={classes?.headline as Record<string, string>}
    position={position}
    as={asHeader}
    asSubtitle={asSubtitle}
  />

  <div class="mx-auto max-w-3xl">
    {
      items &&
        items.map((item, index) => {
          const isOpen = openAllItems || (openFirstItem && index === 0);
          return (
            <div
              class={cn('faq-item border-b border-border', classes?.item)}
              data-yt-faq-item
              data-yt-faq-open={isOpen ? 'true' : 'false'}
            >
              <button
                type="button"
                class={cn(
                  'faq-trigger flex w-full items-center justify-between py-4 text-left font-medium transition-colors hover:text-primary',
                  classes?.trigger
                )}
                aria-expanded={isOpen ? 'true' : 'false'}
                data-yt-faq-trigger
              >
                <span class={cn('text-lg', classes?.title)}>{item.title}</span>
                <svg
                  class="faq-icon h-5 w-5 shrink-0 transition-transform duration-200"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="2"
                  style={isOpen ? 'transform: rotate(180deg);' : ''}
                  data-yt-faq-icon
                >
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div
                class="faq-content overflow-hidden transition-all duration-200"
                data-yt-faq-content
                style={isOpen ? '' : 'height: 0px;'}
              >
                <p class={cn('pb-4 text-muted-foreground', classes?.description)} set:html={item.description} />
              </div>
            </div>
          );
        })
    }
  </div>
</WidgetWrapper>

<script>
  const initFaqWidget = () => {
    const triggers = document.querySelectorAll('[data-yt-faq-trigger]') as NodeListOf<HTMLElement>;
    if (!triggers || triggers.length === 0) return;

    triggers.forEach((trigger) => {
      // Skip if already initialized
      if (trigger.dataset.ytFaqInitialized) return;
      trigger.dataset.ytFaqInitialized = 'true';

      trigger.addEventListener('click', () => {
        const item = trigger.closest('[data-yt-faq-item]') as HTMLElement;
        const content = item?.querySelector('[data-yt-faq-content]') as HTMLElement;
        const icon = trigger.querySelector('[data-yt-faq-icon]') as HTMLElement;

        if (!item || !content) return;

        const isOpen = item.dataset.ytFaqOpen === 'true';

        if (isOpen) {
          // Close
          content.style.height = content.scrollHeight + 'px';
          requestAnimationFrame(() => {
            content.style.height = '0px';
          });
          item.dataset.ytFaqOpen = 'false';
          trigger.setAttribute('aria-expanded', 'false');
          if (icon) icon.style.transform = '';
        } else {
          // Open
          content.style.height = content.scrollHeight + 'px';
          item.dataset.ytFaqOpen = 'true';
          trigger.setAttribute('aria-expanded', 'true');
          if (icon) icon.style.transform = 'rotate(180deg)';

          // Remove fixed height after animation
          const onTransitionEnd = () => {
            content.style.height = '';
            content.removeEventListener('transitionend', onTransitionEnd);
          };
          content.addEventListener('transitionend', onTransitionEnd);
        }
      });
    });
  };

  initFaqWidget();
  document.addEventListener('astro:after-swap', initFaqWidget);
</script>
