---
/**
 * ImagePreload Component
 *
 * Generates a <link rel="preload"> tag for an image to improve LCP.
 * Use this in <head> to preload critical above-the-fold images.
 *
 * Usage:
 * <ImagePreload
 *   src="~/assets/images/hero.jpg"
 *   sizes="(max-width: 900px) 400px, 900px"
 *   widths={[400, 900]}
 * />
 */
import { findImage } from '../../utils/images';
import { astroAsseetsOptimizer, getImagesOptimized, isUnpicCompatible, unpicOptimizer } from '../../utils/images-optimization';
import type { ImageProps } from '../../utils/images-optimization';

interface Props {
  src: ImageProps['src'];
  sizes?: string;
  widths?: number[];
  width?: number;
  height?: number;
  fetchpriority?: 'high' | 'low' | 'auto';
}

const {
  src,
  sizes = '(max-width: 768px) 100vw, 50vw',
  widths = [400, 600],
  width = 600,
  height = 400,
  fetchpriority = 'high'
} = Astro.props;

const _image = await findImage(src);

let imageSrc = '';
let imageSrcset = '';

if (_image) {
  const props: ImageProps = {
    src: _image,
    alt: '',
    width,
    height,
    widths,
    sizes,
  };

  let image;
  if (
    typeof _image === 'string' &&
    (_image.startsWith('http://') || _image.startsWith('https://')) &&
    isUnpicCompatible(_image)
  ) {
    image = await getImagesOptimized(_image, props, unpicOptimizer);
  } else if (_image) {
    image = await getImagesOptimized(_image, props, astroAsseetsOptimizer);
  }

  if (image) {
    imageSrc = image.src;
    imageSrcset = image.attributes.srcset as string || '';
  }
}
---

{imageSrcset ? (
  <link
    rel="preload"
    as="image"
    href={imageSrc}
    imagesrcset={imageSrcset}
    imagesizes={sizes}
    fetchpriority={fetchpriority}
  />
) : imageSrc ? (
  <link
    rel="preload"
    as="image"
    href={imageSrc}
    fetchpriority={fetchpriority}
  />
) : null}
