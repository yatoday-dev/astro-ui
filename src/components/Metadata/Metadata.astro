---
import type { MetadataProps as Props } from './types';
import SEO from '../SEO/SEO.astro';
import type { SEOProps } from '../SEO/SEO.astro';
import { adaptOpenGraphImages } from '../../utils/images';

import merge from 'lodash.merge';
import { METADATA, SITE } from 'vendor:config';

const {
  title,
  ignoreTitleTemplate = false,
  canonical: propCanonical,
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

// Build canonical URL using Astro.site
const canonical = propCanonical || String(new URL(Astro.url.pathname, Astro.site));

// Get language from URL path (e.g., /ru/, /en/, /es/)
const urlParts = Astro.url.pathname.split('/').filter(Boolean);
const locale = urlParts[0] && ['ru', 'en', 'es'].includes(urlParts[0]) ? urlParts[0] : 'ru';

// Build alternate locale links for hreflang
const alternateLocales = ['ru', 'en', 'es']
  .filter((lang) => lang !== locale)
  .map((lang) => ({
    locale: lang,
    url: String(new URL(Astro.url.pathname.replace(`/${locale}/`, `/${lang}/`).replace(`/${locale}`, `/${lang}`), Astro.site)),
  }))
  .concat([
    {
      locale: 'x-default',
      url: String(new URL(Astro.url.pathname.replace(`/${locale}/`, '/ru/').replace(`/${locale}`, '/ru'), Astro.site)),
    },
  ]);

// Merge metadata from config with props
const finalTitle = title || METADATA?.title?.default || '';
const finalDescription = description || METADATA?.description || '';
const finalRobots = {
  index: typeof robots?.index !== 'undefined' ? robots.index : METADATA?.robots?.index !== false,
  follow: typeof robots?.follow !== 'undefined' ? robots.follow : METADATA?.robots?.follow !== false,
};

// Process OpenGraph images
const mergedOpenGraph = merge({}, METADATA?.openGraph || {}, openGraph);
const processedOpenGraph = await adaptOpenGraphImages(mergedOpenGraph, Astro.site);

// Build final OpenGraph props
const ogImage = processedOpenGraph?.images?.[0]
  ? {
      url: String(new URL(processedOpenGraph.images[0].url, Astro.site)),
      width: processedOpenGraph.images[0].width,
      height: processedOpenGraph.images[0].height,
      alt: processedOpenGraph.images[0].alt,
    }
  : undefined;

const finalOpenGraph = {
  title: finalTitle,
  description: finalDescription,
  url: canonical,
  type: (processedOpenGraph?.type as string) || 'website',
  image: ogImage,
  siteName: SITE?.name,
};

// Build final Twitter props
const finalTwitter = merge(
  {
    card: ogImage ? 'summary_large_image' : 'summary',
  },
  METADATA?.twitter || {},
  twitter || {}
);

const seoProps: SEOProps = {
  title: finalTitle,
  description: finalDescription,
  canonical,
  locale,
  alternateLocales,
  robots: finalRobots,
  openGraph: finalOpenGraph,
  twitter: finalTwitter as SEOProps['twitter'],
};
---

<SEO {...seoProps} />
