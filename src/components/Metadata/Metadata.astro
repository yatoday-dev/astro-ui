---
import type { MetadataProps as Props } from './types';
import SEO from '../SEO/SEO.astro';
import type { SEOProps } from '../SEO/SEO.astro';
import { adaptOpenGraphImages } from '../../utils/images';
import { getLocales, getDefaultLocale } from '../../utils/i18n';

import merge from 'lodash.merge';
import { METADATA, SITE } from 'vendor:config';

const {
  title,
  ignoreTitleTemplate = false,
  canonical: propCanonical,
  robots = {},
  description,
  openGraph = {},
  twitter = {},
  alternateUrls,
  i18n,
} = Astro.props;

// Build canonical URL using Astro.site
// Ensure pathname has trailing slash for proper URL structure
let pathname = Astro.url.pathname;
if (!pathname.endsWith('/')) {
  pathname += '/';
}
const canonical = propCanonical || String(new URL(pathname, Astro.site));

// Get supported locales from props or fallback to defaults
const supportedLocales = getLocales(i18n);
const defaultLocale = getDefaultLocale(i18n);

// Get language from URL path (e.g., /ru/, /en/, /es/)
const urlParts = pathname.split('/').filter(Boolean);
const locale = urlParts[0] && supportedLocales.includes(urlParts[0]) ? urlParts[0] : defaultLocale;

// Build alternate locale links for hreflang (including self-reference)
// Use alternateUrls if provided (for blog posts with different slugs per language)
// Otherwise, use path-based replacement for static pages
// When alternateUrls is provided, ONLY include languages that have a URL (no fallback)
const alternateLocales = alternateUrls
  ? supportedLocales
      .filter((lang) => alternateUrls[lang]) // Only include languages with actual URLs
      .map((lang) => ({
        locale: lang,
        url: alternateUrls[lang],
      }))
      .concat(
        alternateUrls[defaultLocale]
          ? [{ locale: 'x-default', url: alternateUrls[defaultLocale] }]
          : []
      )
  : supportedLocales
      .map((lang) => {
        // Replace current locale with target locale and ensure trailing slash
        let altPath = pathname.replace(`/${locale}/`, `/${lang}/`);
        if (!altPath.endsWith('/')) {
          altPath += '/';
        }
        return {
          locale: lang,
          url: String(new URL(altPath, Astro.site)),
        };
      })
      .concat([
        {
          locale: 'x-default',
          // x-default points to the default locale configured in Astro i18n
          url: String(new URL(pathname.replace(`/${locale}/`, `/${defaultLocale}/`), Astro.site)),
        },
      ]);

// Merge metadata from config with props
const finalTitle = title || METADATA?.title?.default || '';
const finalDescription = description || METADATA?.description || '';
const finalRobots = {
  index: typeof robots?.index !== 'undefined' ? robots.index : METADATA?.robots?.index !== false,
  follow: typeof robots?.follow !== 'undefined' ? robots.follow : METADATA?.robots?.follow !== false,
};

// Process OpenGraph images
const mergedOpenGraph = merge({}, METADATA?.openGraph || {}, openGraph);
const processedOpenGraph = await adaptOpenGraphImages(mergedOpenGraph, Astro.site);

// Build final OpenGraph props
const ogImage = processedOpenGraph?.images?.[0]
  ? {
      url: String(new URL(processedOpenGraph.images[0].url, Astro.site)),
      width: processedOpenGraph.images[0].width,
      height: processedOpenGraph.images[0].height,
      alt: processedOpenGraph.images[0].alt,
    }
  : undefined;

const finalOpenGraph = {
  title: processedOpenGraph?.title || finalTitle,
  description: processedOpenGraph?.description || finalDescription,
  url: canonical,
  type: (processedOpenGraph?.type as string) || 'website',
  image: ogImage,
  siteName: SITE?.name,
};

// Build final Twitter props
const finalTwitter = merge(
  {
    card: ogImage ? 'summary_large_image' : 'summary',
  },
  METADATA?.twitter || {},
  twitter || {}
);

const seoProps: SEOProps = {
  title: finalTitle,
  description: finalDescription,
  canonical,
  locale,
  alternateLocales,
  robots: finalRobots,
  openGraph: finalOpenGraph,
  twitter: finalTwitter as SEOProps['twitter'],
};
---

<SEO {...seoProps} />
